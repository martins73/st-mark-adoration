<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>St. Mark Adoration – Lent 2026</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* ── Base ───────────────────────────────────────────── */
        :root {
            --primary:  #2c3e50;
            --accent:   #27ae60;
            --red:      #c62828;
            --bg:       #f4f6f8;
            --border:   #e2e6ea;
            --white:    #ffffff;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: -apple-system, system-ui, sans-serif;
            background: var(--bg);
            color: var(--primary);
            line-height: 1.5;
            padding: 16px;
        }

        /* ── Header ─────────────────────────────────────────── */
        .header {
            text-align: center;
            padding: 24px 16px 16px;
        }

        .header h1 {
            font-size: 1.75rem;
            font-weight: 700;
            margin-bottom: 6px;
        }

        .header .quote {
            font-style: italic;
            color: #555;
            font-size: 1rem;
            margin-bottom: 6px;
        }

        .header .meta {
            font-size: 0.85rem;
            color: #888;
        }

        /* ── Edit mode banner ────────────────────────────────── */
        #edit-banner {
            display: none;
            background: #fff8e1;
            border: 1px solid #ffe082;
            border-radius: 8px;
            padding: 12px 16px;
            margin-bottom: 16px;
            text-align: center;
            font-size: 0.9rem;
            color: #5d4037;
        }

        #edit-banner strong { color: #e65100; }

        #edit-banner button {
            margin-top: 8px;
            background: #e65100;
            color: white;
            border: none;
            padding: 8px 20px;
            border-radius: 6px;
            font-size: 0.88rem;
            font-weight: 600;
            cursor: pointer;
        }

        /* ── Legend ─────────────────────────────────────────── */
        .legend {
            display: flex;
            gap: 18px;
            justify-content: center;
            flex-wrap: wrap;
            margin: 12px 0 20px;
            font-size: 0.8rem;
            color: #666;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .dot {
            width: 11px;
            height: 11px;
            border-radius: 50%;
            display: inline-block;
            flex-shrink: 0;
        }

        .dot.empty  { background: #ffcdd2; border: 1px solid #ef9a9a; }
        .dot.filled { background: #c8e6c9; border: 1px solid #a5d6a7; }

        /* ── Schedule wrapper & table ────────────────────────── */
        .schedule-wrapper {
            overflow-x: auto;
            background: var(--white);
            border-radius: 10px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.07);
            -webkit-overflow-scrolling: touch;
        }

        table.schedule {
            width: 100%;
            border-collapse: collapse;
            min-width: 520px;
        }

        /* Column headers (week dates) */
        table.schedule thead tr {
            background: var(--primary);
        }

        table.schedule th {
            color: var(--white);
            padding: 11px 8px;
            font-size: 0.78rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            text-align: center;
            white-space: nowrap;
        }

        th.time-header {
            text-align: left;
            min-width: 120px;
            padding-left: 14px;
        }

        /* Day separator rows */
        tr.day-band td {
            background: #eef0f2;
            padding: 5px 14px;
            font-size: 0.72rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #777;
            border-top: 2px solid var(--border);
            border-bottom: 1px solid var(--border);
        }

        /* Time label cells */
        td.time-label {
            padding: 0 14px;
            background: #fafbfc;
            white-space: nowrap;
            border-right: 2px solid var(--border);
            border-bottom: 1px solid var(--border);
        }

        td.time-label .time {
            font-size: 0.88rem;
            font-weight: 600;
        }

        /* Slot cells */
        td.slot-cell {
            border-bottom: 1px solid var(--border);
            border-right: 1px solid var(--border);
            padding: 0;
            min-width: 88px;
            text-align: center;
        }

        td.slot-cell:last-child { border-right: none; }

        .cell-inner {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 7px 5px;
            min-height: 52px;
            gap: 3px;
            cursor: pointer;
            transition: background 0.12s;
        }

        .cell-inner:hover { background: #f0f7f2; }

        .cell-count {
            font-size: 0.78rem;
            font-weight: 700;
            padding: 2px 7px;
            border-radius: 10px;
            line-height: 1.4;
        }

        .cell-count.empty  { background: #ffebee; color: var(--red); }
        .cell-count.filled { background: #e8f5e9; color: #2e7d32; }
        .cell-count.mine   { background: #e3f2fd; color: #1565c0; }

        .cell-names {
            font-size: 0.68rem;
            color: #888;
            line-height: 1.3;
            max-width: 80px;
            word-break: break-word;
        }

        .cell-cta {
            font-size: 0.68rem;
            color: var(--accent);
            font-weight: 600;
            opacity: 0;
            transition: opacity 0.12s;
        }

        .cell-inner:hover .cell-cta { opacity: 1; }

        td.slot-cell.unavailable .cell-inner {
            cursor: default;
            color: #ccc;
            font-size: 0.78rem;
        }

        td.slot-cell.unavailable .cell-inner:hover { background: transparent; }

        /* Edit mode: cell highlight for user's own slots */
        td.slot-cell.my-slot .cell-inner {
            background: #e8f4fd;
        }

        td.slot-cell.my-slot .cell-inner:hover {
            background: #d0eaf9;
        }

        /* ── Modal (shared base) ─────────────────────────────── */
        .modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.48);
            align-items: center;
            justify-content: center;
            z-index: 100;
            padding: 16px;
        }

        .modal.open { display: flex; }

        .modal-box {
            background: var(--white);
            border-radius: 12px;
            width: 100%;
            max-width: 440px;
            max-height: 90vh;
            overflow-y: auto;
            padding: 26px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.18);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 4px;
        }

        .modal-header h3 {
            font-size: 1.1rem;
            font-weight: 700;
        }

        .modal-header .modal-sub {
            font-size: 0.83rem;
            color: #777;
            margin-top: 2px;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.4rem;
            cursor: pointer;
            color: #aaa;
            padding: 0;
            line-height: 1;
            flex-shrink: 0;
            margin-left: 12px;
        }

        .modal-close:hover { color: #555; }

        /* Week checkboxes */
        .week-section-label {
            font-size: 0.82rem;
            font-weight: 600;
            color: #555;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin: 16px 0 8px;
        }

        .week-selector {
            margin-bottom: 18px;
        }

        .week-selector label {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 9px 12px;
            border: 1px solid var(--border);
            border-radius: 7px;
            margin-bottom: 6px;
            cursor: pointer;
            transition: background 0.1s, border-color 0.1s;
            font-size: 0.9rem;
        }

        .week-selector label:hover { background: #f5f5f5; }

        .week-selector label:has(input:checked) {
            background: #f0faf2;
            border-color: var(--accent);
        }

        .week-selector input[type="checkbox"] {
            width: 16px;
            height: 16px;
            accent-color: var(--accent);
            flex-shrink: 0;
        }

        .week-label-text { font-weight: 600; }

        .week-status-text {
            margin-left: auto;
            font-size: 0.78rem;
            color: #999;
            white-space: nowrap;
        }

        /* Form fields */
        .field-row {
            display: flex;
            gap: 10px;
        }

        .field-row .field-group { flex: 1; }

        .field-group {
            margin-bottom: 10px;
        }

        .field-group label {
            display: block;
            font-size: 0.82rem;
            font-weight: 600;
            margin-bottom: 4px;
            color: #444;
        }

        .field-group input {
            width: 100%;
            padding: 9px 11px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 0.92rem;
            transition: border-color 0.15s, box-shadow 0.15s;
        }

        .field-group input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(39,174,96,0.12);
        }

        .privacy-note {
            font-size: 0.78rem;
            color: #999;
            margin: 8px 0 16px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .btn-submit {
            width: 100%;
            background: var(--accent);
            color: white;
            border: none;
            padding: 13px;
            border-radius: 7px;
            font-size: 0.98rem;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.15s;
        }

        .btn-submit:hover:not(:disabled) { background: #219a52; }
        .btn-submit:disabled { background: #aaa; cursor: default; }

        /* ── Edit modal overrides ─────────────────────────────── */
        #edit-modal .modal-box {
            max-width: 600px;
        }

        .edit-grid-wrapper {
            overflow-x: auto;
            margin: 14px 0;
            border: 1px solid var(--border);
            border-radius: 8px;
        }

        .edit-grid-wrapper table.schedule {
            min-width: 400px;
        }

        .edit-grid-wrapper td {
            padding: 6px 8px;
            text-align: center;
            border-bottom: 1px solid var(--border);
            border-right: 1px solid var(--border);
            vertical-align: middle;
        }

        .edit-grid-wrapper td:last-child { border-right: none; }

        .edit-grid-wrapper td input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: var(--accent);
            cursor: pointer;
        }

        .edit-grid-wrapper td.unavail {
            color: #ddd;
            font-size: 0.78rem;
        }

        /* ── Success modal ────────────────────────────────────── */
        .success-icon {
            text-align: center;
            font-size: 2.5rem;
            margin-bottom: 8px;
        }

        .link-box {
            background: #f8fffe;
            border: 1px solid #a5d6a7;
            border-radius: 8px;
            padding: 14px;
            margin: 16px 0;
        }

        .link-box-label {
            font-size: 0.8rem;
            font-weight: 700;
            color: #2e7d32;
            margin-bottom: 6px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .link-box-desc {
            font-size: 0.78rem;
            color: #666;
            margin-bottom: 10px;
        }

        .link-display {
            font-size: 0.73rem;
            word-break: break-all;
            background: white;
            padding: 8px 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            color: #444;
            font-family: monospace;
            line-height: 1.4;
        }

        .link-actions {
            display: flex;
            gap: 8px;
            margin-top: 10px;
        }

        .link-actions button, .link-actions a {
            flex: 1;
            padding: 9px 8px;
            border-radius: 6px;
            font-size: 0.82rem;
            font-weight: 600;
            cursor: pointer;
            text-align: center;
            text-decoration: none;
            border: none;
            display: inline-block;
        }

        .btn-copy {
            background: var(--accent);
            color: white;
        }

        .btn-copy:hover { background: #219a52; }

        .btn-email {
            background: #1565c0;
            color: white;
        }

        .btn-email:hover { background: #0d47a1; }

        /* ── Status / Loading ────────────────────────────────── */
        #status {
            text-align: center;
            padding: 48px 20px;
            color: #999;
            font-size: 0.95rem;
        }

        /* ── Toast ───────────────────────────────────────────── */
        #toast {
            position: fixed;
            bottom: 24px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: #2c3e50;
            color: white;
            padding: 12px 22px;
            border-radius: 8px;
            font-size: 0.88rem;
            font-weight: 500;
            box-shadow: 0 4px 16px rgba(0,0,0,0.2);
            transition: transform 0.28s ease;
            z-index: 200;
            max-width: 90vw;
            text-align: center;
        }

        #toast.show { transform: translateX(-50%) translateY(0); }
        #toast.success { background: #2e7d32; }
        #toast.error   { background: #c62828; }

        /* ── Responsive ──────────────────────────────────────── */
        @media (max-width: 500px) {
            body { padding: 8px; }
            .header h1 { font-size: 1.4rem; }
            .modal-box { padding: 18px; }
            .field-row { flex-direction: column; gap: 0; }
            th, td.slot-cell { min-width: 70px; }
            .link-actions { flex-direction: column; }
        }
    </style>
</head>
<body>

<div class="header">
    <h1>St. Mark Adoration</h1>
    <p class="quote">"Could you not watch with me one hour?" — Matthew 26:40</p>
    <p class="meta">Thursdays 9 PM through Fridays 7 PM &middot; Lent 2026</p>
</div>

<!-- Edit mode banner (shown only when ?token= is in URL) -->
<div id="edit-banner">
    <strong>Edit Mode</strong> — You're viewing your current commitments.<br>
    <button onclick="openEditModal()">Open Schedule Editor</button>
</div>

<div class="legend">
    <span class="legend-item"><span class="dot empty"></span> Open slot</span>
    <span class="legend-item"><span class="dot filled"></span> Has volunteers</span>
    <span class="legend-item" style="color:#bbb;">&middot;</span>
    <span class="legend-item">Click any cell to sign up</span>
</div>

<div id="status">Loading schedule…</div>
<div id="schedule"></div>

<!-- ── Sign-Up Modal ─────────────────────────────────────────── -->
<div id="modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="modal-title">
    <div class="modal-box">
        <div class="modal-header">
            <div>
                <h3 id="modal-title">Sign Up</h3>
                <div class="modal-sub" id="modal-sub"></div>
            </div>
            <button class="modal-close" onclick="closeModal()" aria-label="Close">&times;</button>
        </div>

        <p class="week-section-label">Select the weeks you want to commit to:</p>
        <div class="week-selector" id="week-checkboxes">
            <!-- populated dynamically -->
        </div>

        <div class="field-row">
            <div class="field-group">
                <label for="fname">First Name</label>
                <input type="text" id="fname" placeholder="Jane" required autocomplete="given-name">
            </div>
            <div class="field-group">
                <label for="lname">Last Name</label>
                <input type="text" id="lname" placeholder="Smith" required autocomplete="family-name">
            </div>
        </div>
        <div class="field-group">
            <label for="phone">Mobile Phone</label>
            <input type="tel" id="phone" placeholder="(555) 000-0000" required autocomplete="tel">
        </div>
        <div class="field-group">
            <label for="email">Email <span style="font-weight:400;color:#aaa;">(recommended — to receive your edit link)</span></label>
            <input type="email" id="email" placeholder="jane@example.com" autocomplete="email">
        </div>

        <p class="privacy-note">
            <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" style="flex-shrink:0;color:#bbb"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
            Your phone number is kept private and never shown publicly.
        </p>

        <button class="btn-submit" id="submit-btn" onclick="submitSignup()">
            Confirm Commitment
        </button>
    </div>
</div>

<!-- ── Edit Mode Modal ────────────────────────────────────────── -->
<div id="edit-modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="edit-modal-title">
    <div class="modal-box" style="max-width:600px;">
        <div class="modal-header">
            <div>
                <h3 id="edit-modal-title">Edit Your Schedule</h3>
                <div class="modal-sub" id="edit-modal-sub">Check the slots you want to commit to</div>
            </div>
            <button class="modal-close" onclick="closeEditModal()" aria-label="Close">&times;</button>
        </div>

        <p style="font-size:0.82rem;color:#666;margin:8px 0 4px;">
            Check every slot and week you want to attend. Uncheck to remove a commitment.
        </p>

        <div class="edit-grid-wrapper" id="edit-grid-container">
            <!-- populated dynamically -->
        </div>

        <button class="btn-submit" id="edit-submit-btn" onclick="saveEdit()" style="margin-top:4px;">
            Save Changes
        </button>
        <button onclick="closeEditModal()" style="width:100%;margin-top:8px;background:none;border:1px solid #ddd;color:#555;padding:10px;border-radius:7px;font-size:0.92rem;cursor:pointer;">
            Cancel
        </button>
    </div>
</div>

<!-- ── Success Modal ──────────────────────────────────────────── -->
<div id="success-modal" class="modal" role="dialog" aria-modal="true">
    <div class="modal-box">
        <div style="text-align:center;font-size:2.2rem;margin-bottom:6px;">&#10004;</div>
        <h3 style="text-align:center;font-size:1.15rem;margin-bottom:4px;">You're signed up!</h3>
        <p style="text-align:center;font-size:0.85rem;color:#666;margin-bottom:0;">
            Thank you for committing to adoration.
        </p>

        <div class="link-box">
            <div class="link-box-label">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg>
                Your Personal Edit Link
            </div>
            <p class="link-box-desc">
                Save this link to change your schedule later — no login needed. Bookmark it or send it to yourself.
            </p>
            <div class="link-display" id="success-link-display"></div>
            <div class="link-actions">
                <button class="btn-copy" onclick="copyEditLink()">Copy Link</button>
                <a id="mailto-link" class="btn-email" href="#">Email to myself</a>
            </div>
        </div>

        <button onclick="closeSuccessModal()" style="width:100%;background:var(--primary);color:white;border:none;padding:12px;border-radius:7px;font-size:0.95rem;font-weight:600;cursor:pointer;">
            Done
        </button>
    </div>
</div>

<div id="toast" role="status"></div>

<script>
    /*
    ═══════════════════════════════════════════════════════════════
     SUPABASE SETUP — Run this SQL once in your Supabase SQL editor
    ───────────────────────────────────────────────────────────────

    -- 1. Add week columns to slots (safe to run even if already exists)
    ALTER TABLE slots ADD COLUMN IF NOT EXISTS week_start_date DATE;
    ALTER TABLE slots ADD COLUMN IF NOT EXISTS week_label      TEXT;

    -- 2. Add edit token column to signups
    ALTER TABLE signups ADD COLUMN IF NOT EXISTS edit_token UUID;
    CREATE INDEX IF NOT EXISTS idx_signups_edit_token ON signups(edit_token);

    -- 3. Create the public_volunteers view
    CREATE OR REPLACE VIEW public_volunteers AS
    SELECT slot_id, first_name, LEFT(last_name, 1) AS last_initial
    FROM signups;

    -- 4. Tag existing slots as week 1 (Feb 19) — skip if already done
    UPDATE slots
    SET week_start_date = '2026-02-19', week_label = 'Feb 19'
    WHERE week_start_date IS NULL;

    -- 5. Create slots for remaining Lenten weeks
    --    (Only run if your slots table only has the first week)
    INSERT INTO slots (day_text, display_label, sort_order, week_start_date, week_label)
    SELECT day_text, display_label, sort_order, '2026-02-26', 'Feb 26'
    FROM slots WHERE week_start_date = '2026-02-19';

    INSERT INTO slots (day_text, display_label, sort_order, week_start_date, week_label)
    SELECT day_text, display_label, sort_order, '2026-03-05', 'Mar 5'
    FROM slots WHERE week_start_date = '2026-02-19';

    INSERT INTO slots (day_text, display_label, sort_order, week_start_date, week_label)
    SELECT day_text, display_label, sort_order, '2026-03-12', 'Mar 12'
    FROM slots WHERE week_start_date = '2026-02-19';

    INSERT INTO slots (day_text, display_label, sort_order, week_start_date, week_label)
    SELECT day_text, display_label, sort_order, '2026-03-19', 'Mar 19'
    FROM slots WHERE week_start_date = '2026-02-19';

    INSERT INTO slots (day_text, display_label, sort_order, week_start_date, week_label)
    SELECT day_text, display_label, sort_order, '2026-03-26', 'Mar 26'
    FROM slots WHERE week_start_date = '2026-02-19';

    -- 6. RLS policies (if Row Level Security is enabled on your tables)
    --    Run these so the anon key can read/write signups:

    ALTER TABLE signups ENABLE ROW LEVEL SECURITY;

    DROP POLICY IF EXISTS "allow_insert"         ON signups;
    DROP POLICY IF EXISTS "allow_select_by_token" ON signups;
    DROP POLICY IF EXISTS "allow_delete_by_token" ON signups;

    CREATE POLICY "allow_insert"         ON signups FOR INSERT WITH CHECK (true);
    CREATE POLICY "allow_select_by_token" ON signups FOR SELECT USING (true);
    CREATE POLICY "allow_delete_by_token" ON signups FOR DELETE USING (true);

    ═══════════════════════════════════════════════════════════════
    */

    // ── Configuration ──────────────────────────────────────────
    const SUPABASE_URL = 'https://rctzlcvcyookbubmpnot.supabase.co';
    const SUPABASE_KEY = 'sb_publishable_Z1ogXkL8OOumBAkMMZiXgg_I6XHZi4H';
    const client = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // Base URL for generating edit links (works on any host/path)
    const EDIT_LINK_BASE = location.origin + location.pathname;

    // ── App state ───────────────────────────────────────────────
    let allSlots      = [];
    let allVolunteers = [];
    let weeks         = [];   // [{date, label}] sorted ascending
    let timeSlots     = [];   // [{sort_order, display_label, day_text}]

    // Signup modal state
    let modalSortOrder = null;

    // Edit mode state (populated when ?token= is in URL)
    let editToken         = null;
    let editCurrentSlotIds = [];    // slot IDs the volunteer is currently signed up for
    let editVolunteerInfo  = null;  // {first_name, last_name, phone, email}

    // Generated edit link for success modal
    let lastEditLink = '';

    // ── On page load: check for edit token ─────────────────────
    const urlParams = new URLSearchParams(location.search);
    const urlToken  = urlParams.get('token');

    if (urlToken) {
        editToken = urlToken;
        loadEditMode(urlToken);
    } else {
        loadSchedule();
    }

    // ── Data loading ────────────────────────────────────────────
    async function loadSchedule() {
        document.getElementById('status').style.display = '';
        document.getElementById('status').textContent   = 'Loading schedule…';
        document.getElementById('schedule').innerHTML   = '';

        const [{ data: slots, error: e1 }, { data: volunteers, error: e2 }] =
            await Promise.all([
                client.from('slots').select('*').order('sort_order'),
                client.from('public_volunteers').select('*'),
            ]);

        if (e1 || e2) {
            document.getElementById('status').textContent =
                'Could not load the schedule. Please refresh the page.';
            console.error(e1, e2);
            return;
        }

        document.getElementById('status').style.display = 'none';
        allSlots      = slots      || [];
        allVolunteers = volunteers || [];

        // Derive unique weeks
        const weekMap = new Map();
        allSlots.forEach(s => {
            if (s.week_start_date && !weekMap.has(s.week_start_date)) {
                weekMap.set(s.week_start_date, s.week_label || fmtDate(s.week_start_date));
            }
        });
        weeks = [...weekMap.entries()]
            .sort(([a], [b]) => a.localeCompare(b))
            .map(([date, label]) => ({ date, label }));

        // Derive unique time slots (by sort_order)
        const tsMap = new Map();
        allSlots.forEach(s => {
            if (!tsMap.has(s.sort_order)) {
                tsMap.set(s.sort_order, {
                    sort_order:    s.sort_order,
                    display_label: s.display_label,
                    day_text:      s.day_text,
                });
            }
        });
        timeSlots = [...tsMap.values()].sort((a, b) => a.sort_order - b.sort_order);

        if (weeks.length === 0) {
            renderLegacy();
        } else {
            renderGrid();
        }
    }

    // ── Edit mode loading ───────────────────────────────────────
    async function loadEditMode(token) {
        // Show edit banner
        document.getElementById('edit-banner').style.display = 'block';

        // Load schedule first (needed for the grid)
        await loadSchedule();

        // Fetch this volunteer's signups by token
        const { data: mySignups, error } = await client
            .from('signups')
            .select('*')
            .eq('edit_token', token);

        if (error) {
            showToast('Could not load your signups: ' + error.message, 'error');
            return;
        }

        if (!mySignups || mySignups.length === 0) {
            document.getElementById('edit-banner').innerHTML =
                '<strong>Invalid or expired link.</strong> This edit link was not found. ' +
                'Please use the link that was shown when you originally signed up.';
            return;
        }

        const first = mySignups[0];
        editVolunteerInfo = {
            first_name: first.first_name,
            last_name:  first.last_name,
            phone:      first.phone,
            email:      first.email || '',
        };
        editCurrentSlotIds = mySignups.map(s => String(s.slot_id));

        // Highlight their cells in the schedule grid
        highlightMySlots();

        // Auto-open the edit modal
        openEditModal();
    }

    // ── Highlight the volunteer's slots in the main grid ────────
    function highlightMySlots() {
        if (!editCurrentSlotIds.length) return;
        allSlots.forEach(slot => {
            if (editCurrentSlotIds.includes(String(slot.id))) {
                // Find the cell by its onclick attribute's slot id indirectly
                // via data attributes set during render
                const cell = document.querySelector(`[data-slot-id="${slot.id}"]`);
                if (cell) {
                    cell.closest('td').classList.add('my-slot');
                }
            }
        });
    }

    function fmtDate(dateStr) {
        const d = new Date(dateStr + 'T12:00:00');
        return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
    }

    // ── Multi-week grid rendering ───────────────────────────────
    function renderGrid() {
        const wrap = document.getElementById('schedule');

        const outer = document.createElement('div');
        outer.className = 'schedule-wrapper';

        const table = document.createElement('table');
        table.className = 'schedule';

        // thead
        const thead = table.createTHead();
        const headRow = thead.insertRow();
        headRow.insertCell().outerHTML = `<th class="time-header">Time</th>`;
        weeks.forEach(w => {
            const th = document.createElement('th');
            th.textContent = w.label;
            headRow.appendChild(th);
        });

        // tbody
        const tbody = table.createTBody();
        let lastDay = null;

        timeSlots.forEach(ts => {
            if (ts.day_text !== lastDay) {
                const bandRow = tbody.insertRow();
                bandRow.className = 'day-band';
                const bandCell = bandRow.insertCell();
                bandCell.colSpan = weeks.length + 1;
                bandCell.textContent = ts.day_text;
                lastDay = ts.day_text;
            }

            const row = tbody.insertRow();

            // Time label
            const timeTd = row.insertCell();
            timeTd.className = 'time-label';
            timeTd.innerHTML = `<span class="time">${ts.display_label}</span>`;

            // One cell per week
            weeks.forEach(w => {
                const slot = allSlots.find(
                    s => s.sort_order === ts.sort_order && s.week_start_date === w.date
                );
                const td = row.insertCell();
                td.className = 'slot-cell';

                if (!slot) {
                    td.classList.add('unavailable');
                    td.innerHTML = `<div class="cell-inner">—</div>`;
                    return;
                }

                const people   = allVolunteers.filter(v => v.slot_id === slot.id);
                const isMine   = editCurrentSlotIds.includes(String(slot.id));
                const isFilled = people.length > 0;
                const names    = people.map(p => `${p.first_name} ${p.last_initial}.`).join(', ');

                if (isMine) td.classList.add('my-slot');

                td.innerHTML = `
                    <div class="cell-inner"
                         data-slot-id="${slot.id}"
                         onclick="openModal(${ts.sort_order}, '${esc(ts.display_label)}', '${esc(ts.day_text)}', '${w.date}')">
                        <span class="cell-count ${isMine ? 'mine' : (isFilled ? 'filled' : 'empty')}">
                            ${people.length > 0 ? people.length : '0'}
                        </span>
                        ${names ? `<span class="cell-names">${esc(names)}</span>` : ''}
                        <span class="cell-cta">${isMine ? 'Signed up' : '+ Sign Up'}</span>
                    </div>`;
            });
        });

        outer.appendChild(table);
        wrap.appendChild(outer);
    }

    // ── Legacy single-week fallback ─────────────────────────────
    function renderLegacy() {
        const wrap = document.createElement('div');
        wrap.style.cssText =
            'background:white;border-radius:10px;box-shadow:0 2px 12px rgba(0,0,0,0.07);padding:20px;';

        allSlots.forEach(slot => {
            const people    = allVolunteers.filter(v => v.slot_id === slot.id);
            const isFilled  = people.length > 0;
            const namesHtml = people.length
                ? people.map(p => `<span>&#128100; ${esc(p.first_name)} ${esc(p.last_initial)}.</span>`).join(' ')
                : '<span style="color:#ccc">Empty</span>';

            const card = document.createElement('div');
            card.style.cssText =
                'border-bottom:1px solid #eee;padding:15px 0;display:flex;justify-content:space-between;align-items:center;';
            card.innerHTML = `
                <div>
                    <div style="font-size:0.78rem;text-transform:uppercase;color:#999;letter-spacing:1px;">
                        ${esc(slot.day_text)}
                    </div>
                    <span style="font-weight:600;font-size:1.05rem;">${esc(slot.display_label)}</span>
                    <span style="display:inline-block;padding:2px 8px;border-radius:12px;font-size:0.75rem;
                                 font-weight:700;margin-left:8px;
                                 background:${isFilled ? '#e8f5e9' : '#ffebee'};
                                 color:${isFilled ? '#2e7d32' : '#c62828'};">
                        ${people.length} Committed
                    </span>
                    <div style="font-size:0.88rem;color:#555;margin-top:4px;">${namesHtml}</div>
                </div>
                <button onclick="openModalLegacy(${slot.id}, '${esc(slot.display_label)}')"
                        style="background:white;border:1px solid #2c3e50;color:#2c3e50;
                               padding:5px 14px;border-radius:5px;cursor:pointer;white-space:nowrap;">
                    Sign Up
                </button>`;
            wrap.appendChild(card);
        });

        document.getElementById('schedule').appendChild(wrap);
    }

    // ── Signup Modal (multi-week) ────────────────────────────────
    function openModal(sortOrder, timeLabel, dayText, preselectedDate) {
        if (editToken) {
            // In edit mode, clicking a cell opens the edit modal instead
            openEditModal();
            return;
        }
        modalSortOrder = sortOrder;

        document.getElementById('modal-title').textContent = timeLabel;
        document.getElementById('modal-sub').textContent   = dayText + ' · Select weeks below';

        const container = document.getElementById('week-checkboxes');
        container.innerHTML = '';

        weeks.forEach(w => {
            const slot = allSlots.find(
                s => s.sort_order === sortOrder && s.week_start_date === w.date
            );
            if (!slot) return;

            const count       = allVolunteers.filter(v => v.slot_id === slot.id).length;
            const isPreselect = w.date === preselectedDate;

            const lbl = document.createElement('label');
            lbl.innerHTML = `
                <input type="checkbox" value="${slot.id}" ${isPreselect ? 'checked' : ''}>
                <span class="week-label-text">${esc(w.label)}</span>
                <span class="week-status-text">${count > 0 ? count + ' committed' : 'Open'}</span>`;
            container.appendChild(lbl);
        });

        document.getElementById('modal').classList.add('open');
        document.getElementById('fname').focus();
    }

    function openModalLegacy(slotId, label) {
        document.getElementById('modal-title').textContent = label;
        document.getElementById('modal-sub').textContent   = '';
        const container = document.getElementById('week-checkboxes');
        container.innerHTML =
            `<input type="hidden" id="legacy-slot-id" value="${slotId}">`;
        document.getElementById('modal').classList.add('open');
        document.getElementById('fname').focus();
    }

    function closeModal() {
        document.getElementById('modal').classList.remove('open');
        ['fname', 'lname', 'phone', 'email'].forEach(id => {
            document.getElementById(id).value = '';
        });
    }

    document.getElementById('modal').addEventListener('click', e => {
        if (e.target === document.getElementById('modal')) closeModal();
    });

    // ── Edit Modal ──────────────────────────────────────────────
    function openEditModal() {
        const container = document.getElementById('edit-grid-container');
        container.innerHTML = '';

        if (editVolunteerInfo) {
            document.getElementById('edit-modal-sub').textContent =
                `Editing: ${editVolunteerInfo.first_name} ${editVolunteerInfo.last_name}`;
        }

        // Build a mini schedule table with checkboxes
        const table = document.createElement('table');
        table.className = 'schedule';

        // Header
        const thead = table.createTHead();
        const headRow = thead.insertRow();
        headRow.insertCell().outerHTML = `<th class="time-header" style="font-size:0.75rem;">Time</th>`;
        weeks.forEach(w => {
            const th = document.createElement('th');
            th.textContent = w.label;
            th.style.fontSize = '0.75rem';
            headRow.appendChild(th);
        });

        // Body
        const tbody = table.createTBody();
        let lastDay = null;

        timeSlots.forEach(ts => {
            if (ts.day_text !== lastDay) {
                const bandRow = tbody.insertRow();
                bandRow.className = 'day-band';
                const bandCell = bandRow.insertCell();
                bandCell.colSpan = weeks.length + 1;
                bandCell.textContent = ts.day_text;
                lastDay = ts.day_text;
            }

            const row = tbody.insertRow();
            const timeTd = row.insertCell();
            timeTd.className = 'time-label';
            timeTd.style.fontSize = '0.82rem';
            timeTd.innerHTML = `<span class="time">${ts.display_label}</span>`;

            weeks.forEach(w => {
                const slot = allSlots.find(
                    s => s.sort_order === ts.sort_order && s.week_start_date === w.date
                );
                const td = row.insertCell();
                td.style.textAlign = 'center';
                td.style.padding = '5px';
                td.style.borderBottom = '1px solid var(--border)';
                td.style.borderRight = '1px solid var(--border)';

                if (!slot) {
                    td.className = 'unavail';
                    td.textContent = '—';
                    return;
                }

                const isChecked = editCurrentSlotIds.includes(String(slot.id));
                td.innerHTML = `
                    <label style="cursor:pointer;display:flex;align-items:center;justify-content:center;">
                        <input type="checkbox"
                               class="edit-slot-cb"
                               value="${slot.id}"
                               ${isChecked ? 'checked' : ''}
                               style="width:17px;height:17px;accent-color:var(--accent);">
                    </label>`;
            });
        });

        container.appendChild(table);
        document.getElementById('edit-modal').classList.add('open');
    }

    function closeEditModal() {
        document.getElementById('edit-modal').classList.remove('open');
    }

    document.getElementById('edit-modal').addEventListener('click', e => {
        if (e.target === document.getElementById('edit-modal')) closeEditModal();
    });

    // ── Save edits ──────────────────────────────────────────────
    async function saveEdit() {
        const btn = document.getElementById('edit-submit-btn');
        btn.textContent = 'Saving…';
        btn.disabled    = true;

        // Collect newly selected slot IDs
        const newSlotIds = [...document.querySelectorAll('.edit-slot-cb:checked')]
            .map(cb => cb.value);

        if (newSlotIds.length === 0) {
            showToast('Please select at least one slot.', 'error');
            btn.textContent = 'Save Changes';
            btn.disabled    = false;
            return;
        }

        // Delete all existing signups for this token
        const { error: delError } = await client
            .from('signups')
            .delete()
            .eq('edit_token', editToken);

        if (delError) {
            showToast('Could not update: ' + delError.message, 'error');
            btn.textContent = 'Save Changes';
            btn.disabled    = false;
            return;
        }

        // Re-insert with same token and same volunteer info
        const rows = newSlotIds.map(slot_id => ({
            slot_id,
            first_name: editVolunteerInfo.first_name,
            last_name:  editVolunteerInfo.last_name,
            phone:      editVolunteerInfo.phone,
            email:      editVolunteerInfo.email || null,
            edit_token: editToken,
        }));

        const { error: insError } = await client.from('signups').insert(rows);

        if (insError) {
            showToast('Could not save changes: ' + insError.message, 'error');
        } else {
            editCurrentSlotIds = newSlotIds;
            closeEditModal();
            showToast(
                `Updated! You're committed to ${newSlotIds.length} slot${newSlotIds.length !== 1 ? 's' : ''}.`,
                'success'
            );
            // Reload schedule to reflect changes
            await loadSchedule();
            highlightMySlots();
        }

        btn.textContent = 'Save Changes';
        btn.disabled    = false;
    }

    // ── Sign-up submission ──────────────────────────────────────
    async function submitSignup() {
        const btn = document.getElementById('submit-btn');

        // Collect selected slot IDs
        const legacyHidden = document.getElementById('legacy-slot-id');
        const slotIds = legacyHidden
            ? [legacyHidden.value]
            : [...document.querySelectorAll('#week-checkboxes input[type="checkbox"]:checked')]
                .map(cb => cb.value);

        if (slotIds.length === 0) {
            showToast('Please select at least one week.', 'error');
            return;
        }

        const fname = document.getElementById('fname').value.trim();
        const lname = document.getElementById('lname').value.trim();
        const phone = document.getElementById('phone').value.trim();
        const email = document.getElementById('email').value.trim();

        if (!fname || !lname || !phone) {
            showToast('Please fill in your name and phone number.', 'error');
            return;
        }

        btn.textContent = 'Saving…';
        btn.disabled    = true;

        // Generate a single token shared across all slots in this signup session
        const token = crypto.randomUUID();

        const rows = slotIds.map(slot_id => ({
            slot_id,
            first_name: fname,
            last_name:  lname,
            phone,
            email: email || null,
            edit_token: token,
        }));

        const { error } = await client.from('signups').insert(rows);

        if (error) {
            showToast('Could not save: ' + error.message, 'error');
        } else {
            closeModal();
            const editLink = EDIT_LINK_BASE + '?token=' + token;
            lastEditLink   = editLink;
            showSuccessModal(editLink, email, fname);
            loadSchedule();
        }

        btn.textContent = 'Confirm Commitment';
        btn.disabled    = false;
    }

    // ── Success modal ────────────────────────────────────────────
    function showSuccessModal(editLink, email, firstName) {
        document.getElementById('success-link-display').textContent = editLink;

        // Build mailto link if email was provided
        const mailtoLink = document.getElementById('mailto-link');
        if (email) {
            const subject = encodeURIComponent('Your St. Mark Adoration Edit Link');
            const body    = encodeURIComponent(
                `Hi ${firstName},\n\nHere is your personal link to view or change your adoration schedule:\n\n${editLink}\n\nNo login is required — just click the link anytime.\n\nGod bless you!`
            );
            mailtoLink.href  = `mailto:${encodeURIComponent(email)}?subject=${subject}&body=${body}`;
            mailtoLink.style.display = '';
        } else {
            mailtoLink.style.display = 'none';
        }

        document.getElementById('success-modal').classList.add('open');
    }

    function closeSuccessModal() {
        document.getElementById('success-modal').classList.remove('open');
    }

    document.getElementById('success-modal').addEventListener('click', e => {
        if (e.target === document.getElementById('success-modal')) closeSuccessModal();
    });

    function copyEditLink() {
        navigator.clipboard.writeText(lastEditLink || document.getElementById('success-link-display').textContent)
            .then(() => showToast('Link copied!', 'success'))
            .catch(() => {
                // Fallback for browsers without clipboard API
                const el = document.getElementById('success-link-display');
                const range = document.createRange();
                range.selectNodeContents(el);
                const sel = window.getSelection();
                sel.removeAllRanges();
                sel.addRange(range);
                showToast('Link selected — press Ctrl+C to copy', '');
            });
    }

    // ── Toast ───────────────────────────────────────────────────
    function showToast(msg, type = '') {
        const toast = document.getElementById('toast');
        toast.textContent = msg;
        toast.className   = 'show ' + type;
        clearTimeout(toast._timer);
        toast._timer = setTimeout(() => { toast.className = ''; }, 4500);
    }

    // ── Utility: escape HTML for inline attributes / innerHTML ──
    function esc(str) {
        return String(str)
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&#39;');
    }

    // ── Keyboard: Escape closes modals ───────────────────────────
    document.addEventListener('keydown', e => {
        if (e.key === 'Escape') {
            closeModal();
            closeEditModal();
            closeSuccessModal();
        }
    });
</script>

</body>
</html>
