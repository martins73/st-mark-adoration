<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>St. Mark Adoration – Lent 2026</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* ── Base ───────────────────────────────────────────── */
        :root {
            --primary:  #2c3e50;
            --accent:   #27ae60;
            --red:      #c62828;
            --bg:       #f4f6f8;
            --border:   #e2e6ea;
            --white:    #ffffff;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: -apple-system, system-ui, sans-serif;
            background: var(--bg);
            color: var(--primary);
            line-height: 1.5;
            padding: 16px;
        }

        /* ── Header ─────────────────────────────────────────── */
        .header {
            text-align: center;
            padding: 24px 16px 16px;
        }

        .header h1 {
            font-size: 1.75rem;
            font-weight: 700;
            margin-bottom: 6px;
        }

        .header .quote {
            font-style: italic;
            color: #555;
            font-size: 1rem;
            margin-bottom: 6px;
        }

        .header .meta {
            font-size: 0.85rem;
            color: #888;
        }

        /* ── Legend ─────────────────────────────────────────── */
        .legend {
            display: flex;
            gap: 18px;
            justify-content: center;
            flex-wrap: wrap;
            margin: 12px 0 20px;
            font-size: 0.8rem;
            color: #666;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .dot {
            width: 11px;
            height: 11px;
            border-radius: 50%;
            display: inline-block;
            flex-shrink: 0;
        }

        .dot.empty  { background: #ffcdd2; border: 1px solid #ef9a9a; }
        .dot.filled { background: #c8e6c9; border: 1px solid #a5d6a7; }

        /* ── Schedule wrapper & table ────────────────────────── */
        .schedule-wrapper {
            overflow-x: auto;
            background: var(--white);
            border-radius: 10px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.07);
            -webkit-overflow-scrolling: touch;
        }

        table.schedule {
            width: 100%;
            border-collapse: collapse;
            table-layout: fixed;
        }

        /* Column headers (week dates) */
        table.schedule thead tr {
            background: var(--primary);
        }

        table.schedule th {
            color: var(--white);
            padding: 11px 8px;
            font-size: 0.78rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            text-align: center;
            white-space: nowrap;
        }

        th.time-header {
            text-align: left;
            min-width: 120px;
            padding-left: 14px;
        }

        /* Day separator rows (Thursday / Friday band) */
        tr.day-band td {
            background: #eef0f2;
            padding: 5px 14px;
            font-size: 0.72rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #777;
            border-top: 2px solid var(--border);
            border-bottom: 1px solid var(--border);
        }

        /* Time label cells */
        td.time-label {
            padding: 0 14px;
            background: #fafbfc;
            white-space: nowrap;
            border-right: 2px solid var(--border);
            border-bottom: 1px solid var(--border);
        }

        td.time-label .time {
            font-size: 0.88rem;
            font-weight: 600;
        }

        /* Slot cells */
        td.slot-cell {
            border-bottom: 1px solid var(--border);
            border-right: 1px solid var(--border);
            padding: 0;
            min-width: 78px;
            text-align: center;
        }

        td.slot-cell:last-child { border-right: none; }

        .cell-inner {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 6px 4px;
            min-height: 44px;
            gap: 3px;
            cursor: pointer;
            transition: background 0.12s;
        }

        .cell-inner:hover { background: #f0f7f2; }

        .cell-count {
            font-size: 0.72rem;
            font-weight: 700;
            padding: 2px 7px;
            border-radius: 10px;
            line-height: 1.4;
        }

        .cell-count.empty  { background: #ffebee; color: var(--red); }
        .cell-count.filled { background: #e8f5e9; color: #2e7d32; }

        .cell-names {
            font-size: 0.62rem;
            color: #888;
            line-height: 1.3;
            max-width: 80px;
            word-break: break-word;
        }

        .cell-cta {
            font-size: 0.62rem;
            color: var(--accent);
            font-weight: 600;
            opacity: 0;
            transition: opacity 0.12s;
        }

        .cell-inner:hover .cell-cta { opacity: 1; }

        td.slot-cell.unavailable .cell-inner {
            cursor: default;
            color: #ccc;
            font-size: 0.78rem;
        }

        td.slot-cell.unavailable .cell-inner:hover { background: transparent; }

        /* ── Modal ───────────────────────────────────────────── */
        .modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.48);
            align-items: center;
            justify-content: center;
            z-index: 100;
            padding: 16px;
        }

        .modal.open { display: flex; }

        .modal-box {
            background: var(--white);
            border-radius: 12px;
            width: 100%;
            max-width: 440px;
            max-height: 90vh;
            overflow-y: auto;
            padding: 26px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.18);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 4px;
        }

        .modal-header h3 {
            font-size: 1.1rem;
            font-weight: 700;
        }

        .modal-header .modal-sub {
            font-size: 0.83rem;
            color: #777;
            margin-top: 2px;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.4rem;
            cursor: pointer;
            color: #aaa;
            padding: 0;
            line-height: 1;
            flex-shrink: 0;
            margin-left: 12px;
        }

        .modal-close:hover { color: #555; }

        /* Week checkboxes */
        .week-section-label {
            font-size: 0.82rem;
            font-weight: 600;
            color: #555;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin: 16px 0 8px;
        }

        .week-selector {
            margin-bottom: 18px;
        }

        .week-selector label {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 9px 12px;
            border: 1px solid var(--border);
            border-radius: 7px;
            margin-bottom: 6px;
            cursor: pointer;
            transition: background 0.1s, border-color 0.1s;
            font-size: 0.9rem;
        }

        .week-selector label:hover { background: #f5f5f5; }

        .week-selector label:has(input:checked) {
            background: #f0faf2;
            border-color: var(--accent);
        }

        .week-selector input[type="checkbox"] {
            width: 16px;
            height: 16px;
            accent-color: var(--accent);
            flex-shrink: 0;
        }

        .week-label-text { font-weight: 600; }

        .week-status-text {
            margin-left: auto;
            font-size: 0.78rem;
            color: #999;
            white-space: nowrap;
        }

        /* Form fields */
        .field-row {
            display: flex;
            gap: 10px;
        }

        .field-row .field-group { flex: 1; }

        .field-group {
            margin-bottom: 10px;
        }

        .field-group label {
            display: block;
            font-size: 0.82rem;
            font-weight: 600;
            margin-bottom: 4px;
            color: #444;
        }

        .field-group input {
            width: 100%;
            padding: 9px 11px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 0.92rem;
            transition: border-color 0.15s, box-shadow 0.15s;
        }

        .field-group input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(39,174,96,0.12);
        }

        .privacy-note {
            font-size: 0.78rem;
            color: #999;
            margin: 8px 0 16px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .btn-submit {
            width: 100%;
            background: var(--accent);
            color: white;
            border: none;
            padding: 13px;
            border-radius: 7px;
            font-size: 0.98rem;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.15s;
        }

        .btn-submit:hover:not(:disabled) { background: #219a52; }
        .btn-submit:disabled { background: #aaa; cursor: default; }

        /* ── Status / Loading ────────────────────────────────── */
        #status {
            text-align: center;
            padding: 48px 20px;
            color: #999;
            font-size: 0.95rem;
        }

        .callout {
            background: #fff8e1;
            border: 1px solid #ffe08a;
            border-radius: 8px;
            color: #7a5b12;
            padding: 10px 12px;
            margin: 0 auto 14px;
            max-width: 1100px;
            font-size: 0.82rem;
            line-height: 1.4;
        }

        .week-actions {
            display: flex;
            gap: 8px;
            margin: 0 0 10px;
            flex-wrap: wrap;
        }

        .mini-btn {
            border: 1px solid var(--border);
            background: #f8fafb;
            color: #445;
            border-radius: 6px;
            font-size: 0.75rem;
            padding: 5px 8px;
            cursor: pointer;
        }

        .mini-btn:hover { background: #f0f4f6; }

        /* ── Toast ───────────────────────────────────────────── */
        #toast {
            position: fixed;
            bottom: 24px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: #2c3e50;
            color: white;
            padding: 12px 22px;
            border-radius: 8px;
            font-size: 0.88rem;
            font-weight: 500;
            box-shadow: 0 4px 16px rgba(0,0,0,0.2);
            transition: transform 0.28s ease;
            z-index: 200;
            max-width: 90vw;
            text-align: center;
        }

        #toast.show { transform: translateX(-50%) translateY(0); }
        #toast.success { background: #2e7d32; }
        #toast.error   { background: #c62828; }

        /* ── Responsive ──────────────────────────────────────── */
        @media (max-width: 500px) {
            body { padding: 8px; }
            .header h1 { font-size: 1.4rem; }
            .modal-box { padding: 18px; }
            .field-row { flex-direction: column; gap: 0; }
            th, td.slot-cell { min-width: 62px; }
        }
    </style>
</head>
<body>

<div class="header">
    <h1>St. Mark Adoration</h1>
    <p class="quote">"Could you not watch with me one hour?" — Matthew 26:40</p>
    <p class="meta">Thursdays 9 PM through Fridays 7 PM &middot; Lent 2026</p>
</div>

<div class="legend">
    <span class="legend-item"><span class="dot empty"></span> Open slot</span>
    <span class="legend-item"><span class="dot filled"></span> Has volunteers</span>
    <span class="legend-item" style="color:#bbb;">&middot;</span>
    <span class="legend-item">Click any cell to sign up</span>
</div>

<div id="status">Loading schedule…</div>
<div id="week-callout" class="callout" style="display:none;"></div>
<div id="schedule"></div>

<!-- ── Sign-Up Modal ─────────────────────────────────────────── -->
<div id="modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="modal-title">
    <div class="modal-box">
        <div class="modal-header">
            <div>
                <h3 id="modal-title">Sign Up</h3>
                <div class="modal-sub" id="modal-sub"></div>
            </div>
            <button class="modal-close" onclick="closeModal()" aria-label="Close">&times;</button>
        </div>

        <p class="week-section-label">Select the weeks you want to commit to:</p>
        <div class="week-actions">
            <button type="button" class="mini-btn" onclick="setWeekSelection(true)">Select all</button>
            <button type="button" class="mini-btn" onclick="setWeekSelection(false)">Clear</button>
            <button type="button" class="mini-btn" onclick="selectOpenWeeks()">Only open weeks</button>
        </div>
        <div class="week-selector" id="week-checkboxes">
            <!-- populated dynamically -->
        </div>

        <div class="field-row">
            <div class="field-group">
                <label for="fname">First Name</label>
                <input type="text" id="fname" placeholder="Jane" required autocomplete="given-name">
            </div>
            <div class="field-group">
                <label for="lname">Last Name</label>
                <input type="text" id="lname" placeholder="Smith" required autocomplete="family-name">
            </div>
        </div>
        <div class="field-group">
            <label for="phone">Mobile Phone</label>
            <input type="tel" id="phone" placeholder="(555) 000-0000" required autocomplete="tel">
        </div>
        <div class="field-group">
            <label for="email">Email <span style="font-weight:400;color:#aaa;">(optional)</span></label>
            <input type="email" id="email" placeholder="jane@example.com" autocomplete="email">
        </div>

        <p class="privacy-note">
            <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" style="flex-shrink:0;color:#bbb"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
            Your phone number is kept private and never shown publicly.
        </p>

        <button class="btn-submit" id="submit-btn" onclick="submitSignup()">
            Confirm / Update Commitment
        </button>
    </div>
</div>

<div id="toast" role="status"></div>

<script>
    /*
    ═══════════════════════════════════════════════════════════════
     DB SETUP — Run this SQL once in your Supabase SQL editor
     to enable multi-week support.
    ───────────────────────────────────────────────────────────────

    -- 1. Add week columns to the slots table
    ALTER TABLE slots ADD COLUMN IF NOT EXISTS week_start_date DATE;
    ALTER TABLE slots ADD COLUMN IF NOT EXISTS week_label      TEXT;

    -- 2. Tag your existing slots as the first week (Feb 19)
    UPDATE slots
    SET week_start_date = '2026-02-19', week_label = 'Feb 19'
    WHERE week_start_date IS NULL;

    -- 3. Duplicate time slots for each remaining Lenten Thursday
    INSERT INTO slots (day_text, display_label, sort_order, week_start_date, week_label)
    SELECT day_text, display_label, sort_order, '2026-02-26', 'Feb 26'
    FROM slots WHERE week_start_date = '2026-02-19';

    INSERT INTO slots (day_text, display_label, sort_order, week_start_date, week_label)
    SELECT day_text, display_label, sort_order, '2026-03-05', 'Mar 5'
    FROM slots WHERE week_start_date = '2026-02-19';

    INSERT INTO slots (day_text, display_label, sort_order, week_start_date, week_label)
    SELECT day_text, display_label, sort_order, '2026-03-12', 'Mar 12'
    FROM slots WHERE week_start_date = '2026-02-19';

    INSERT INTO slots (day_text, display_label, sort_order, week_start_date, week_label)
    SELECT day_text, display_label, sort_order, '2026-03-19', 'Mar 19'
    FROM slots WHERE week_start_date = '2026-02-19';

    INSERT INTO slots (day_text, display_label, sort_order, week_start_date, week_label)
    SELECT day_text, display_label, sort_order, '2026-03-26', 'Mar 26'
    FROM slots WHERE week_start_date = '2026-02-19';

    ═══════════════════════════════════════════════════════════════
    */

    // ── Configuration ──────────────────────────────────────────
    const SUPABASE_URL = 'https://rctzlcvcyookbubmpnot.supabase.co';
    const SUPABASE_KEY = 'sb_publishable_Z1ogXkL8OOumBAkMMZiXgg_I6XHZi4H';
    const client = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // ── App state ───────────────────────────────────────────────
    let allSlots      = [];
    let allVolunteers = [];
    let weeks         = [];   // [{date, label}] sorted ascending
    let timeSlots     = [];   // [{sort_order, display_label, day_text}] sorted

    // State tracked while a modal is open
    let modalSortOrder = null;

    const EXPECTED_LENT_WEEKS = [
        { date: '2026-02-19', label: 'Feb 19' },
        { date: '2026-02-26', label: 'Feb 26' },
        { date: '2026-03-05', label: 'Mar 5' },
        { date: '2026-03-12', label: 'Mar 12' },
        { date: '2026-03-19', label: 'Mar 19' },
        { date: '2026-03-26', label: 'Mar 26' },
        { date: '2026-04-02', label: 'Holy Friday (Apr 3)' }
    ];


    // ── Data loading ────────────────────────────────────────────
    async function loadSchedule() {
        document.getElementById('status').style.display = '';
        document.getElementById('status').textContent   = 'Loading schedule…';
        document.getElementById('schedule').innerHTML   = '';

        const [{ data: slots, error: e1 }, { data: volunteers, error: e2 }] =
            await Promise.all([
                client.from('slots').select('*').order('sort_order'),
                client.from('public_volunteers').select('*'),
            ]);

        if (e1 || e2) {
            document.getElementById('status').textContent =
                'Could not load the schedule. Please refresh the page.';
            console.error(e1, e2);
            return;
        }

        document.getElementById('status').style.display = 'none';
        allSlots      = slots      || [];
        allVolunteers = volunteers || [];

        // Derive unique weeks from DB
        const weekMap = new Map();
        allSlots.forEach(s => {
            if (s.week_start_date && !weekMap.has(s.week_start_date)) {
                weekMap.set(s.week_start_date, s.week_label || fmtDate(s.week_start_date));
            }
        });
        const dbWeeksAvailable = weekMap.size > 0;

        // Always show all expected Lent Fridays (including Holy Friday),
        // even when those slot rows are not seeded yet.
        const allWeekMap = new Map();
        EXPECTED_LENT_WEEKS.forEach(w => allWeekMap.set(w.date, w.label));
        [...weekMap.entries()].forEach(([date, label]) => {
            allWeekMap.set(date, label);
        });

        weeks = [...allWeekMap.entries()]
            .sort(([a], [b]) => a.localeCompare(b))
            .map(([date, label]) => ({ date, label }));

        // Derive unique time slots (by sort_order)
        const tsMap = new Map();
        allSlots.forEach(s => {
            if (!tsMap.has(s.sort_order)) {
                tsMap.set(s.sort_order, {
                    sort_order:    s.sort_order,
                    display_label: s.display_label,
                    day_text:      s.day_text,
                });
            }
        });
        timeSlots = [...tsMap.values()].sort((a, b) => a.sort_order - b.sort_order);

        if (!dbWeeksAvailable) {
            // Legacy schema: no week_start_date column yet → single-week fallback
            renderLegacy();
        } else {
            showWeekCoverageHint();
            renderGrid();
        }
    }

    function showWeekCoverageHint() {
        const callout = document.getElementById('week-callout');
        const missing = EXPECTED_LENT_WEEKS.filter(w => !weeks.some(existing => existing.date === w.date));

        if (missing.length === 0) {
            callout.style.display = 'none';
            return;
        }

        const labels = missing.map(w => w.label).join(', ');
        callout.innerHTML = `
            <strong>Heads up:</strong> The schedule is missing some Lent weeks (${esc(labels)}),
            so those columns are currently shown as unavailable.
            After seeding those week slots in Supabase, parishioners will be able to select them.
        `;
        callout.style.display = 'block';
    }

    function fmtDate(dateStr) {
        const d = new Date(dateStr + 'T12:00:00');
        return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
    }

    // ── Multi-week grid rendering ───────────────────────────────
    function renderGrid() {
        const wrap = document.getElementById('schedule');
        document.getElementById('week-callout').style.display = 'none';

        const outer = document.createElement('div');
        outer.className = 'schedule-wrapper';

        const table = document.createElement('table');
        table.className = 'schedule';

        // ── thead ──
        const thead = table.createTHead();
        const headRow = thead.insertRow();
        headRow.insertCell().outerHTML = `<th class="time-header">Time</th>`;
        weeks.forEach(w => {
            const th = document.createElement('th');
            th.textContent = w.label;
            headRow.appendChild(th);
        });

        // ── tbody ──
        const tbody = table.createTBody();
        let lastDay = null;

        timeSlots.forEach(ts => {
            // Day band separator (e.g., "Thursday" / "Friday")
            if (ts.day_text !== lastDay) {
                const bandRow = tbody.insertRow();
                bandRow.className = 'day-band';
                const bandCell = bandRow.insertCell();
                bandCell.colSpan = weeks.length + 1;
                bandCell.textContent = ts.day_text;
                lastDay = ts.day_text;
            }

            const row = tbody.insertRow();

            // Time label
            const timeTd = row.insertCell();
            timeTd.className = 'time-label';
            timeTd.innerHTML = `<span class="time">${ts.display_label}</span>`;

            // One cell per week
            weeks.forEach(w => {
                const slot = allSlots.find(
                    s => s.sort_order === ts.sort_order && s.week_start_date === w.date
                );
                const td = row.insertCell();
                td.className = 'slot-cell';

                if (!slot) {
                    td.classList.add('unavailable');
                    td.innerHTML = `<div class="cell-inner">—</div>`;
                    return;
                }

                const people   = allVolunteers.filter(v => v.slot_id === slot.id);
                const isFilled = people.length > 0;
                const names    = people.map(p => `${p.first_name} ${p.last_initial}.`).join(', ');

                td.innerHTML = `
                    <div class="cell-inner"
                         onclick="openModal(${ts.sort_order}, '${esc(ts.display_label)}', '${esc(ts.day_text)}', '${w.date}')">
                        <span class="cell-count ${isFilled ? 'filled' : 'empty'}">
                            ${people.length > 0 ? people.length : '0'}
                        </span>
                        ${names ? `<span class="cell-names">${esc(names)}</span>` : ''}
                        <span class="cell-cta">+ Sign Up</span>
                    </div>`;
            });
        });

        outer.appendChild(table);
        wrap.appendChild(outer);
    }

    // ── Legacy single-week fallback (no week_start_date column) ─
    function renderLegacy() {
        const wrap = document.getElementById('schedule');
        document.getElementById('week-callout').style.display = 'none';

        const outer = document.createElement('div');
        outer.className = 'schedule-wrapper';
        const table = document.createElement('table');
        table.className = 'schedule';

        const thead = table.createTHead();
        const headRow = thead.insertRow();
        headRow.insertCell().outerHTML = `<th class="time-header">Time</th>`;
        headRow.insertCell().outerHTML = `<th>This Week</th>`;

        const tbody = table.createTBody();
        let lastDay = null;

        allSlots
            .sort((a, b) => a.sort_order - b.sort_order)
            .forEach(slot => {
                if (slot.day_text !== lastDay) {
                    const bandRow = tbody.insertRow();
                    bandRow.className = 'day-band';
                    const bandCell = bandRow.insertCell();
                    bandCell.colSpan = 2;
                    bandCell.textContent = slot.day_text;
                    lastDay = slot.day_text;
                }

                const row = tbody.insertRow();
                row.insertCell().outerHTML =
                    `<td class="time-label"><span class="time">${esc(slot.display_label)}</span></td>`;

                const people = allVolunteers.filter(v => v.slot_id === slot.id);
                const names = people.map(p => `${p.first_name} ${p.last_initial}.`).join(', ');
                row.insertCell().outerHTML = `
                    <td class="slot-cell">
                        <div class="cell-inner" onclick="openModalLegacy(${slot.id}, '${esc(slot.display_label)}')">
                            <span class="cell-count ${people.length ? 'filled' : 'empty'}">${people.length}</span>
                            ${names ? `<span class="cell-names">${esc(names)}</span>` : ''}
                            <span class="cell-cta">+ Sign Up</span>
                        </div>
                    </td>`;
            });

        outer.appendChild(table);
        wrap.appendChild(outer);
    }

    // ── Modal (multi-week) ──────────────────────────────────────
    function openModal(sortOrder, timeLabel, dayText, preselectedDate) {
        modalSortOrder = sortOrder;

        document.getElementById('modal-title').textContent = timeLabel;
        document.getElementById('modal-sub').textContent   = dayText + ' · Select weeks below';

        const container = document.getElementById('week-checkboxes');
        container.innerHTML = '';

        weeks.forEach(w => {
            const slot = allSlots.find(
                s => s.sort_order === sortOrder && s.week_start_date === w.date
            );
            if (!slot) return;

            const count       = allVolunteers.filter(v => v.slot_id === slot.id).length;
            const isPreselect = w.date === preselectedDate;

            const lbl = document.createElement('label');
            lbl.innerHTML = `
                <input type="checkbox" value="${slot.id}" data-count="${count}" ${isPreselect ? 'checked' : ''}>
                <span class="week-label-text">${esc(w.label)}</span>
                <span class="week-status-text">${count > 0 ? count + ' committed' : 'Open'}</span>`;
            container.appendChild(lbl);
        });

        document.getElementById('modal').classList.add('open');
        document.getElementById('fname').focus();
    }

    // Legacy: single fixed slot (no weeks)
    function openModalLegacy(slotId, label) {
        document.getElementById('modal-title').textContent = label;
        document.getElementById('modal-sub').textContent   = '';
        const container = document.getElementById('week-checkboxes');
        container.innerHTML =
            `<input type="hidden" id="legacy-slot-id" value="${slotId}">`;
        document.getElementById('modal').classList.add('open');
        document.getElementById('fname').focus();
    }

    function closeModal() {
        document.getElementById('modal').classList.remove('open');
        ['fname', 'lname', 'phone', 'email'].forEach(id => {
            document.getElementById(id).value = '';
        });
    }

    function setWeekSelection(selectAll) {
        document.querySelectorAll('#week-checkboxes input[type="checkbox"]').forEach(cb => {
            cb.checked = selectAll;
        });
    }

    function selectOpenWeeks() {
        document.querySelectorAll('#week-checkboxes input[type="checkbox"]').forEach(cb => {
            cb.checked = cb.dataset.count === '0';
        });
    }

    // Close on backdrop click
    document.getElementById('modal').addEventListener('click', e => {
        if (e.target === document.getElementById('modal')) closeModal();
    });

    // ── Sign-up submission ──────────────────────────────────────
    async function submitSignup() {
        const btn = document.getElementById('submit-btn');

        // Collect selected slot IDs
        const legacyHidden = document.getElementById('legacy-slot-id');
        const slotIds = legacyHidden
            ? [legacyHidden.value]
            : [...document.querySelectorAll('#week-checkboxes input[type="checkbox"]:checked')]
                .map(cb => cb.value);

        if (slotIds.length === 0) {
            showToast('Please select at least one week.', 'error');
            return;
        }

        const fname = document.getElementById('fname').value.trim();
        const lname = document.getElementById('lname').value.trim();
        const phone = document.getElementById('phone').value.trim();
        const email = document.getElementById('email').value.trim().toLowerCase();

        if (!fname || !lname || !phone) {
            showToast('Please fill in your name and phone number.', 'error');
            return;
        }

        btn.textContent = 'Saving…';
        btn.disabled    = true;

        const rows = slotIds.map(slot_id => ({
            slot_id,
            first_name: fname,
            last_name:  lname,
            phone,
            email: email || null,
        }));

        let error = null;

        if (email) {
            // Re-using an email updates commitments by replacing prior rows.
            const { error: deleteError } = await client
                .from('signups')
                .delete()
                .eq('email', email);

            if (deleteError) {
                error = deleteError;
            }
        }

        if (!error) {
            const { error: insertError } = await client.from('signups').insert(rows);
            error = insertError;
        }

        if (error) {
            showToast('Could not save: ' + error.message, 'error');
        } else {
            const n = slotIds.length;
            const action = email ? 'updated' : 'saved';
            showToast(`Thank you, ${fname}! Your commitments were ${action} for ${n} slot${n !== 1 ? 's' : ''}.`, 'success');
            closeModal();
            loadSchedule();
        }

        btn.textContent = 'Confirm / Update Commitment';
        btn.disabled    = false;
    }

    // ── Toast ───────────────────────────────────────────────────
    function showToast(msg, type = '') {
        const toast = document.getElementById('toast');
        toast.textContent = msg;
        toast.className   = 'show ' + type;
        clearTimeout(toast._timer);
        toast._timer = setTimeout(() => { toast.className = ''; }, 4500);
    }

    // ── Utility: escape HTML for inline attributes / innerHTML ──
    function esc(str) {
        return String(str)
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&#39;');
    }

    // ── Keyboard: Escape closes modal ───────────────────────────
    document.addEventListener('keydown', e => {
        if (e.key === 'Escape') closeModal();
    });

    // ── Init ────────────────────────────────────────────────────
    loadSchedule();
</script>

</body>
</html>
